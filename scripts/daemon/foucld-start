#!/bin/bash
# foucld-start.sh

foucld-start() {
    local bin_path=""
    local pidfile="$HOME/.local/share/foucl/latest.pid"
    local log_dir="./.foucl"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --bin)
                shift
                bin_path="${1:-}"
                ;;
            --pidfile)
                shift
                pidfile="${1:-}"
                ;;
            --log-dir)
                shift
                log_dir="${1:-}"
                ;;
            *)
                echo "Unknown option for foucld start: $1" >&2
                return 1
                ;;
        esac
        shift
    done

    if [[ -z "$bin_path" ]]; then
        mapfile -t candidates < <(find . -maxdepth 1 -type f -name 'foucl*' -perm -u+x -printf '%p\n')
        if [[ "${#candidates[@]}" -eq 0 ]]; then
            echo "Unable to find a foucl executable in $(pwd)" >&2
            return 1
        fi
        if [[ "${#candidates[@]}" -gt 1 ]]; then
            echo "Could not determine which foucl executable to run. Found:" >&2
            printf '%s\n' "${candidates[@]}" >&2
            return 1
        fi
        bin_path="${candidates[0]}"
    fi

    if [[ ! -x "$bin_path" ]]; then
        echo "Executable not found or not executable: $bin_path" >&2
        return 1
    fi

    mkdir -p "$(dirname "$pidfile")"
    mkdir -p "$log_dir"
    "$bin_path" > "$log_dir/.foucl.log" 2>&1 &
    echo "$!" > "$pidfile"
    echo "Started foucl (pid=$(cat "$pidfile"))"
}
